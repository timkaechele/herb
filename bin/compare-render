#!/usr/bin/env ruby
# frozen_string_literal: true

require "pathname"
require "optparse"
require_relative "lib/compare_helpers"

include CompareHelpers

def usage
  puts "Usage: #{$PROGRAM_NAME} [options] <file>"
  puts ""
  puts "Renders an ERB template with both Erubi::Engine and Herb::Engine and shows the diff."
  puts ""
  puts "Options:"
  puts "  --no-escape              Disable HTML escaping"
  puts "  --escape                 Enable HTML escaping (default: false)"
  puts "  -h, --help               Show this help message"
  exit(1)
end

options = {}
options[:escape] = false

OptionParser.new do |opts|
  opts.banner = "Usage: #{$PROGRAM_NAME} [options] <file>"
  parse_common_options(opts, options) { usage }
end.parse!

options[:show_template] = true unless options.key?(:show_template)

file_path = ARGV[0]

unless file_path
  puts "Error: No file specified"
  usage
end

unless File.exist?(file_path)
  puts "Error: File '#{file_path}' not found"
  exit(1)
end

load_dependencies

template = File.read(file_path)
show_template(file_path, template) if options[:show_template]

begin
  herb_engine = Herb::Engine.new(template, options)
  herb_output = eval(herb_engine.src)
rescue StandardError => e
  puts "Herb render error: #{e.message}"
  exit(1)
end

begin
  erubi_engine = Erubi::Engine.new(template, options)
  erubi_output = eval(erubi_engine.src)
rescue StandardError => e
  puts "Erubi render error: #{e.message}"
  exit(1)
end

if herb_output == erubi_output
  puts "✓ Outputs match!"
  puts ""
  puts "Output:"
  puts herb_output
  exit(0)
else
  puts "✗ Outputs differ!"
  puts ""
  puts ""

  diff_output = diff_rendered_outputs(erubi_output, herb_output)
  puts diff_output if diff_output

  exit(1)
end
